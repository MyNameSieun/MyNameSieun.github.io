---
title: "[Next.js] Next.js React-Query ì‚¬ìš©í•˜ê¸°"
categories: [Next.js]
toc_label: Contents
toc: true
toc_sticky: true
author_profile: true
sidebar:
  nav: "counts"
---

<br>

# 1. React Query ê¸°ë³¸ ì„¤ì •

## 1.1 app/providers.tsx ìƒì„±

> ê¸°ë³¸ì ìœ¼ë¡œ `layout.tsx`ëŠ” ì„œë²„ ì»´í¬ë„ŒíŠ¸ë¡œ ë™ì‘í•œë‹¤. ë”°ë¼ì„œ í´ë¼ì´ì–¸íŠ¸ ì „ìš© ì»´í¬ë„ŒíŠ¸ì¸ `provider`ë¥¼ ë£¨íŠ¸ ë ˆì´ì•„ì›ƒì—ì„œ ì§ì ‘ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.

ë”°ë¼ì„œ `app/providers.tsx`ì— providerì„ `use client`ì§€ì‹œì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ë¡œ ë§Œë“¤ì–´ ì„œë²„ ì»´í¬ë„ŒíŠ¸ì¸ `layout.tsx`ì— ì£¼ì…í•˜ì—¬ì•¼ í•œë‹¤.

```tsx
// app/providers.tsx
"use client"; // í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ë¡œ ì§€ì •

import { QueryClient, QueryClientProvider } from "@tanstack/react-query";

// í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ë¡œ React Query Provider ì •ì˜

const Providers = ({ children }: { children: React.ReactNode }) => {
  const queryClient = new QueryClient();

  return (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  );
};

export default Providers;
```

<br>

> `provider` ì¶”ê°€ì‹œ ì•„ë˜ì™€ ê°™ì´ í™•ì¥í•  ìˆ˜ ìˆë‹¤.

```tsx
// app/providers.tsx
"use client"; // í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ë¡œ ì§€ì •

import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { ReactQueryDevtools } from "@tanstack/react-query-devtools";
import { SessionProvider } from "next-auth/react";

const Providers = ({ children }: { children: React.ReactNode }) => {
  const queryClient = new QueryClient();

  return (
    <SessionProvider>
      <QueryClientProvider client={queryClient}>
        {children} <ReactQueryDevtools initialIsOpen={false} />
      </QueryClientProvider>
    </SessionProvider>
  );
};

export default Providers;
```

<br>

## 1.2 DevTools í™œìš©

React Query DevToolsë¥¼ ì‚¬ìš©í•˜ë©´ ì¿¼ë¦¬ ìƒíƒœ, ìºì‹œ ìƒíƒœ ë° ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<br>

> ì„¤ì¹˜

```shell
yarn add @tanstack/react-query-devtools
```

<br>

> DevTools ì‚¬ìš© ì˜ˆì œ

```tsx
// app/providers.tsx
"use client";

import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { ReactQueryDevtools } from "@tanstack/react-query-devtools";

const Providers = ({ children }: { children: React.ReactNode }) => {
  const queryClient = new QueryClient();

  return (
    <QueryClientProvider client={queryClient}>
      {children} <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
};

export default Providers;
```

![](/assets/images/2024/2024-10-02-19-18-55.png)

<br>

## 1.3 layout.tsxì—ì„œ Provider ì£¼ì…

> ì´ì œ ìƒì„±í•œ `providers`ë¥¼ `root layout`ì— ì£¼ì…í•˜ì—¬ í•˜ìœ„ ì»´í¬ë„ŒíŠ¸ì—ì„œ React Queryë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ì.

```tsx
import type { Metadata } from "next";
import "./globals.css";
import Providers from "./providers";

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body>
        {/* í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì¸ ReactQueryProviderë¡œ ê°ì‹¸ì¤Œ */}
        <Providers>{children}</Providers>
      </body>
    </html>
  );
}
```

<br><br>

# 2. React Query ì‚¬ìš©í•˜ê¸°

ì œëŒ€ë¡œ `QueryClientProvider`ê°€ ì£¼ì…ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ë³´ì!

## 2.1 JSON Server ì„¤ì¹˜ ë° ë°ì´í„° ì„¤ì •

> ë¨¼ì € json-serverì„ ì„¤ì¹˜í•˜ì

```shell
yarn global add json-server
```

<br>

> ê·¸ í›„, `db.json` íŒŒì¼ì„ ë§Œë“¤ì–´ ì•„ë˜ì™€ ê°™ì€ ë‚´ìš©ì„ ë„£ì–´ì£¼ì. ì´ json íŒŒì¼ì„ dbë¡œ ì‚¬ìš©í•œë‹¤.

```json
{
  "posts": [
    { "id": "1", "title": "íƒ€ì´í‹€1", "content": "ë‚´ìš©1" },
    { "id": "2", "title": "íƒ€ì´í‹€2", "content": "ë‚´ìš©2" }
  ]
}
```

<br>

> ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ `json-server`ì„ ì‹¤í–‰í•˜ì.

```shell
json-server --watch db.json --port 4000
```

<br>

> ì°¸ê³  (json-server ì‚¬ìš© ì‹œ)

`package.json` íŒŒì¼ì— ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¶”ê°€í•˜ì—¬ JSON ì„œë²„ë¥¼ ê°„í¸í•˜ê²Œ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ë‚´ìš©ì„ `package.json` íŒŒì¼ì˜ scripts ì„¹ì…˜ì— ì¶”ê°€í•´ ë³´ì.

```json
"scripts": {
  "serve": "json-server --watch db.json --port 4000"
}
```

ì´ì œ í„°ë¯¸ë„ì—ì„œ `yarn serve` ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ë©´, `json-server`ê°€ `db.json` íŒŒì¼ì„ ê°ì‹œ(â€“watch)í•˜ê³  4000ë²ˆ í¬íŠ¸ì—ì„œ ì„œë²„ë¥¼ ì‹œì‘í•œë‹¤.

<br>

## 2.2 axios ì„¤ì¹˜

```shell
yarn add axios
```

<br>

## 2.3 useQuery ì‚¬ìš©

`use client` ì§€ì‹œì–´ëŠ” `useQuery`ì™€ `useMutation`ì„ ì‚¬ìš©í•  ë•Œ í•„ìš”í•˜ë‹¤.

```tsx
"use client";

import { useQuery } from "@tanstack/react-query";
import axios from "axios";
import React from "react";

// ì¸í„°í˜ì´ìŠ¤ ì •ì˜
interface Post {
  id: string;
  title: string;
  content: string;
}

// ì„œë²„ë¡œë¶€í„° ê²Œì‹œê¸€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
export const fetchPosts = async () => {
  try {
    const response = await axios.get("http://localhost:4000/posts");
    return response.data;
  } catch (error) {
    console.error(error);
  }
};

// ê²Œì‹œê¸€ ëª©ë¡ì„ ë³´ì—¬ì£¼ëŠ” ì»´í¬ë„ŒíŠ¸
const PostBasic = () => {
  // React Queryì˜ `useQuery` í›…ìœ¼ë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const {
    data: posts, // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ dataë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë°˜í™˜, dataë¥¼ postsë¡œ ì´ë¦„ ë³€ê²½
    isLoading,
    isError,
  } = useQuery({
    queryKey: ["posts"], // ì¿¼ë¦¬í‚¤ë¡œ ë°ì´í„° ê³ ìœ í•˜ê²Œ ì‹ë³„í•˜ê³  ìºì‹œ
    queryFn: fetchPosts, // ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜
  });

  if (isLoading) {
    return <p>ë¡œë”©ì¤‘...</p>;
  }

  if (isError) {
    return <p>ì—ëŸ¬ ë°œìƒ!</p>;
  }

  // ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆì„ ë•Œ ê²Œì‹œê¸€ ëª©ë¡ì„ ë Œë”ë§
  return (
    <main>
      {posts.map((post: Post) => (
        <ul key={post.id}>
          <li>{post.title}</li>
          <li>{post.content}</li>
        </ul>
      ))}
    </main>
  );
};

export default PostBasic;
```

ìœ„ ì½”ë“œë¥¼ ì ìš©í•œ í›„, í˜ì´ì§€ë¥¼ ë¡œë“œí•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ì •ìƒì ìœ¼ë¡œ ë°ì´í„°ê°€ í‘œì‹œëœë‹¤.

![](/assets/images/2024/2024-09-30-17-01-53.png)

<br><br>

# 3. íš¨ìœ¨ì ìœ¼ë¡œ React Query ì‚¬ìš©í•˜ê¸°

ìœ„ì—ì„œ ì„¤ê³„í•œ ì½”ë“œë¥¼ [[React Query íš¨ìœ¨ì  êµ¬ì¡° ì„¤ê³„ì— ëŒ€í•œ ê³ ì°°â†—ï¸]](https://mynamesieun.github.io/react/React-Query-%ED%9A%A8%EC%9C%A8%EC%A0%81-%EA%B5%AC%EC%A1%B0-%EC%84%A4%EA%B3%84%EC%97%90-%EB%8C%80%ED%95%9C-%EA%B3%A0%EC%B0%B0/) í¬ìŠ¤íŒ…ì„ ì°¸ê³ í•˜ì—¬ ë¦¬íŒ©í† ë§ì„ í•´ë³´ì.

<br>

## 3.1 íŒŒì¼ êµ¬ì¡°

> React Queryì™€ ê´€ë ¨ëœ ê¸°ëŠ¥ì„ ëª¨ë“ˆí™”í•˜ì—¬ ê´€ë¦¬í•˜ê¸° ì‰½ê²Œ ë‚˜ëˆ„ì—ˆë‹¤.

```
ğŸ“‚ components
â””â”€â”€â”€ğŸ“‚ hooks
    â””â”€â”€â”€ğŸ“‚ query
        â”œâ”€â”€â”€ğŸ“„ keys.constant.ts      # ì¿¼ë¦¬ í‚¤ ìƒìˆ˜ë¥¼ ì •ì˜í•œ íŒŒì¼
        â”œâ”€â”€â”€ğŸ“„ usePostsQuery.ts      # í¬ìŠ¤íŠ¸ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¿¼ë¦¬ í›…
        â””â”€â”€â”€ğŸ“„ usePostsMutation.ts   # í¬ìŠ¤íŠ¸ ì¶”ê°€ ë° ì‚­ì œë¥¼ ì²˜ë¦¬í•˜ëŠ” ë®¤í…Œì´ì…˜ í›…
ğŸ“‚ types
â””â”€â”€â”€ğŸ“‚ post-types.ts               # í¬ìŠ¤íŠ¸ ê´€ë ¨ íƒ€ì… ì •ì˜
ğŸ“‚ api
â””â”€â”€â”€ğŸ“‚ posts.ts                   # í¬ìŠ¤íŠ¸ ê´€ë ¨ API í˜¸ì¶œ í•¨ìˆ˜
```

<br>

## 3.2 ì¿¼ë¦¬ í‚¤ ìƒìˆ˜ë¡œ ê´€ë¦¬í•˜ê¸°

> React Queryì—ì„œ ë°ì´í„°ë¥¼ íŒ¨ì¹­í•  ë•Œ queryKeyë¥¼ ì‚¬ìš©í•˜ì—¬ ê° ë°ì´í„°ë¥¼ ì‹ë³„í•œë‹¤. í•˜ì§€ë§Œ ë¬¸ìì—´ë¡œ ì§ì ‘ ì‚¬ìš©í•˜ë‹¤ ë³´ë©´ ì˜¤íƒ€ë¡œ ì¸í•œ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

ë”°ë¼ì„œ, ì¿¼ë¦¬ í‚¤ë¥¼ ìƒìˆ˜í™”í•˜ì—¬ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

```tsx
// app/components/hooks/query/keys.constant.ts
export const QUERY_KEYS = {
  POSTS: "posts",
  USERS: "users",
};
```

<br>

## 3.3 .env.local ì„¤ì •

> ê°œë°œ í™˜ê²½ì—ì„œë§Œ ì‚¬ìš©ë˜ëŠ” í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ê¸° ìœ„í•´ `.env.local` íŒŒì¼ì„ ì„¤ì •í•˜ì˜€ë‹¤.

```shell
NEXT_PUBLIC_SERVER_URL=http://localhost:4000
```

<br>

## 3.4 types í´ë” ìƒì„±

> `app/types/post-types.ts`

```ts
// app/types/post-types.ts
export interface Post {
  id: string;
  title: string;
  content: string;
}
```

<br>

## 3.5 API ìš”ì²­

API ìš”ì²­ì„ ë³„ë„ íŒŒì¼ì—

```tsx
// app/api/posts.ts

import axios from "axios";
import { Post } from "../types/post-types";

const postsAxios = axios.create({
  baseURL: process.env.NEXT_PUBLIC_SERVER_URL,
});

// posts ì¡°íšŒ
export const fetchPosts = async () => {
  const response = await postsAxios.get("/posts");
  return response.data;
};

// posts ì‘ì„±
export const addPost = async (data: Post) => {
  const response = await postsAxios.post("/posts", data);
  return response.data;
};

// posts ì‚­ì œ
export const deletePost = async (id: string) => {
  const response = await postsAxios.delete(`/posts/${id}`);
  return response.data;
};

// posts ìˆ˜ì •
export const editPost = async (id: string, data: Post) => {
  const response = await postsAxios.patch(`/posts/${id}`, data);
  return response.data;
};
```

<br>

## 3.6 useQuery ì»¤ìŠ¤í…€ í›…

> useQuery ì»¤ìŠ¤í…€ í›… ìƒì„±

React Queryë¥¼ ì‚¬ìš©í•˜ì—¬ useQueryë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¡œì§ì„ ë°˜ë³µí•˜ê²Œ ë˜ë©´, ì½”ë“œê°€ ì¤‘ë³µë˜ê³  ìœ ì§€ë³´ìˆ˜ê°€ ì–´ë ¤ì›Œì§„ë‹¤.

ì•„ë˜ì²˜ëŸ¼ ì»¤ìŠ¤í…€ í›…ì„ í™œìš©í•˜ì—¬ ë°ì´í„° íŒ¨ì¹­ ë¡œì§ì„ ì»´í¬ë„ŒíŠ¸ì—ì„œ ë¶„ë¦¬í•˜ë©´, ì»´í¬ë„ŒíŠ¸ëŠ” ë°ì´í„° ë¡œë”© ìƒíƒœì™€ ì—ëŸ¬ë§Œ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤.

```tsx
// app/components/hooks/query/usePostsQuery.ts

"use client";

import { useQuery } from "@tanstack/react-query";
import { QUERY_KEYS } from "./key.constant";
import { fetchPosts } from "@/app/api/posts";

export const usePostsQuery = () =>
  useQuery({
    queryKey: [QUERY_KEYS.POSTS],
    queryFn: fetchPosts, // ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜
  });
```

<br>

> useQuery ì»¤ìŠ¤í…€ í›… ì‚¬ìš©

ì´ì œ ì»´í¬ë„ŒíŠ¸ì—ì„œ ê°„ë‹¨í•˜ê²Œ useQuery ì»¤ìŠ¤í…€ í›…ì„ í˜¸ì¶œí•˜ì—¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.

```tsx
"use client";

import { usePostsQuery } from "../components/hooks/query/usePostsQuery";
import { Post } from "../types/post-types";

// ê²Œì‹œê¸€ ëª©ë¡ì„ ë³´ì—¬ì£¼ëŠ” ì»´í¬ë„ŒíŠ¸
const PostBasic = () => {
  const { data: posts = [], isLoading, isError } = usePostsQuery(); // ì»¤ìŠ¤í…€ í›… í˜¸ì¶œ

  if (isLoading) {
    return <p>ë¡œë”©ì¤‘...</p>;
  }

  if (isError) {
    return <p>ì—ëŸ¬ ë°œìƒ!</p>;
  }

  return (
    <main>
      {posts.map((post: Post) => (
        <ul key={post.id}>
          <li>{post.title}</li>
          <li>{post.content}</li>
        </ul>
      ))}
    </main>
  );
};

export default PostBasic;
```

<br>

## 3.7 useMutation ì»¤ìŠ¤í…€ í›…

> useMutation ì»¤ìŠ¤í…€ í›… ìƒì„±

useQueryì™€ ë§ˆì°¬ê°€ì§€ë¡œ, ì»¤ìŠ¤í…€ í›…ì„ í†µí•´ useMutationì˜ ë¡œì§ì„ ìº¡ìŠí™”í•˜ì—¬ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ì.

```tsx
"use client";

import { useMutation, useQueryClient } from "@tanstack/react-query";
import { addPost, deletePost } from "@/app/api/posts";
import { QUERY_KEYS } from "./key.constant";

export const useAddPostMutation = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: addPost,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.POSTS] });
      alert("ì¶”ê°€ ì™„ë£Œ!");
    },
    onError: (error) => {
      console.error("ì¶”ê°€ ì‹¤íŒ¨:", error);
      alert("ì¶”ê°€ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    },
  });
};

export const useDeletePostMutation = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: deletePost,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: [QUERY_KEYS.POSTS] });
      alert("ì‚­ì œ ì™„ë£Œ!");
    },
    onError: (error) => {
      console.error("ì‚­ì œ ì‹¤íŒ¨:", error);
      alert("ì‚­ì œ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    },
  });
};
```

<br>

> useMutation ì»¤ìŠ¤í…€ í›… ì‚¬ìš©

```tsx
"use client";

import { useDeletePostMutation } from "../components/hooks/query/usePostsMutation";
import { usePostsQuery } from "../components/hooks/query/usePostsQuery";
import { Post } from "../types/post-types";

// ê²Œì‹œê¸€ ëª©ë¡ì„ ë³´ì—¬ì£¼ëŠ” ì»´í¬ë„ŒíŠ¸
const PostBasic = () => {
  const { data: posts = [], isLoading, isError } = usePostsQuery(); // ì»¤ìŠ¤í…€ í›… í˜¸ì¶œ

  // ì‚­ì œë¥¼ ìœ„í•œ ë®¤í…Œì´ì…˜ í›…
  const deletePostMutation = useDeletePostMutation();

  const handleDeletePost = (id: string) => {
    deletePostMutation.mutate(id); // Post ì‚­ì œ
  };

  if (isLoading) {
    return <p>ë¡œë”©ì¤‘...</p>;
  }

  if (isError) {
    return <p>ì—ëŸ¬ ë°œìƒ!</p>;
  }

  return (
    <section>
      {posts.map((post: Post) => (
        <ul key={post.id}>
          <li>ì œëª©: {post.title}</li>
          <li>ë‚´ìš©: {post.content}</li>
          <button onClick={() => handleDeletePost(post.id)}>ì‚­ì œí•˜ê¸°</button>
        </ul>
      ))}
    </section>
  );
};

export default PostBasic;
```

<br><br>

# 4. ë¶€ë¡ - React Query ì‚¬ìš©ì‹œ ê³ ë ¤í•  ì‚¬í•­â­

> ì•„ë˜ í¬ìŠ¤íŒ…ì„ ì°¸ê³ í•˜ì—¬ React Queryë¥¼ ë³´ë‹¤ ë” êµ¬ì¡°ì ì´ê³  íš¨ìœ¨ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

- [[React Query íš¨ìœ¨ì  êµ¬ì¡° ì„¤ê³„ì— ëŒ€í•œ ê³ ì°°â†—ï¸]](https://mynamesieun.github.io/react/React-Query-%ED%9A%A8%EC%9C%A8%EC%A0%81-%EA%B5%AC%EC%A1%B0-%EC%84%A4%EA%B3%84%EC%97%90-%EB%8C%80%ED%95%9C-%EA%B3%A0%EC%B0%B0/)
- [[React Queryì—ì„œ SSR êµ¬í˜„í•˜ê¸°(with Streaming, Hydration)â†—ï¸]](https://mynamesieun.github.io/next.js/React-Query%EC%97%90%EC%84%9C-SSR-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0(with-Streaming,-Hydration)/)

<br>
