---
title: "[Network] #9 네트워크 계층과 IP 주소"
categories: [Network]
toc_label: Contents
toc: true
toc_sticky: true
author_profile: true
sidebar:
  nav: "counts"
---

<br>

---

[[혼자 공부하는 네트워크↗️]](https://www.youtube.com/watch?v=c62qssA4hYI&list=PLYH7OjNUOWLVwdRF6_QmJVR4cQdMp0SU1&index=1)을 바탕으로 정리한 글입니다.
{: .notice--danger}

- 지난 포스팅에서 같은 네트워크 내에 호스트끼리 정보를 주고 받기 위해 케이블, 허브, 스위치 같은 장비를 학습했다.
- 이번 포스팅에는 **LAN을 넘어 다른 네트워크와 속한 호스트와 패킷을 주고받을 수 있게** 하는 "네트워크 계층"에 대해 학습해보자.

---

<br>

# 1. 물리 계층과 데이터링크 계층의 한계

> 물리 계층과 데이터 링크 계층만으로는 LAN을 넘어서 통신하기 어려운데, 그 이유는 아래와 같다.

① 다른 네트워크까지의 도달 경로를 파악하기 어렵다.

- 지구 반대편에 있는 친구와 패킷을 주고받는다고 가정하자. 이 경우는 네트워크 간 통신이 이루어지기 때문에 패킷이 여러 네트워크를 거쳐 이동할 것이다.
- 이때, 패킷이 어떤 경로로 이동해야 최적인지를 물리 계층과 데이터링크 계층의 기술 만으로는 판단하기 어렵다.
- 따라서 네트워크 계층의 <span style="color:indianred">라우팅(routing)</span>으로 패킷이 이동할 최적의 경로를 결정해야 한다.
- 라우터(router)는 라우팅을 수행하는 대표적인 장비를 의미한다.<br><br>
  ![](/assets/images/2024/2024-10-06-15-01-39.png)

<br>

② 모든 네트워크에 속한 모든 호스트의 위치를 특정하기 어렵다.

- MAC 주소는 기본적으로 네트워크 인터페이스마다 부여가 되는데, 호스트는 시시때때로 속해있는 네트워크가 얼마든지 달라질 수도 있기 때문에, MAC 주소 하나만으로 모든 네트워크에 속한 모든 호스트의 위치를 특정하기 어렵다.
- 이러한 MAC 주소의 한계를 극복하기 위해 사용되는 네트워크 주소 체계를 <span style="color:indianred">IP 주소</span>라고 한다.
- MAC 주소와 IP 주소는 함께 사용되고, 기본적으로 IP 주소를 우선 활용한다.

|           MAC 주소           |                            IP 주소                             |
| :--------------------------: | :------------------------------------------------------------: |
|    택배의 **수신인** 역할    |                     택배의 **수신지** 역할                     |
|          물리 주소           |                           논리 주소                            |
| NIC마다 할당되는 고정된 주소 | - 유동적으로 할당<br>- 자동으로 할당 받거나 사용자가 직접 할당 |

![](/assets/images/2024/2024-10-06-15-06-12.png)

<br><br>

# 2. 네트워크 계층의 핵심, IP

> 물리 계층과 데이터 링크 계층의 한계를 극복하는 프로토콜이다.

IP 프로토콜은 주소 지정(IP addressing), 단편화(IP fragmentation)의 기능을 제공한다.

## 2.1 주소 지정

> 주소 지정이란, IP 주소(IPv4)를 바탕으로 송수신 대상을 지정하는 것을 의미한다.

- 4바이트(32비트)로 하나의 주소를 표현한다. `192.168.1.1`
- 숫자당 8비트로 표현되면 0~255 범위 안에 있는 네 개의 19진수로 표기한다.
- 각각의 숫자는 점(.)으로 구분하는데, 이 점으로 구분된 각각의 숫자를 옥텟(octet)이라고 한다.

<br>

## 2.2 단편화

> 단편화란, 전송하고자 하는 패킷의 크기를 **MTU** 이하의 복수의 패킷으로 나눈 것을 의미한다.

- MTU(Maximum Transmission Unit)란?

  - 한 번에 전송 가능한 IP 패킷의 최대 크기를 의미한다.
  - IP 패킷의 헤더도 MTU 크기에 포함된다.
  - 일반적으로 MTU 크기는 **1500바이트**이며, MTU 크기 이하로 나누어진 패킷은 수신지에 도착하면 다시 재조합된다.

  ![](/assets/images/2024/2024-10-06-17-18-32.png)

<br>

> 이더넷 프레임에서 페이로드에 명시할 수 있는 일반적인 데이터 크기는 1500바이트로 제한되어 있는 이유는, 데이터 부분의 `IPv4 패킷 헤더 + IPv4 패킷 페이로드` 보다 커지면 단편화가 이루어지기 때문이다.

아래 그림의 데이터 부분(IPv4 패킷 헤더 + IPv4 패킷 페이로드)이 IPv4의 패킷 구조이다.

![](/assets/images/2024/2024-10-06-17-23-24.png)

<br>

## 2.3 IPv4 패킷의 핵심 필드

> IPv4 패킷의 핵심 필드는 1)식별자, 2)플래그, 3)단편화 오프셋, 4)TTL, 5)프로토콜, 6)송신지 IP 주소, 7)수신지 IP 주소 가 존재한다.

- 1)식별자, 2)플래그, 3)단편화 오프셋 필드를 기준으로 단편화가 이루어진다.
- 6)송신지 IP 주소, 7)수신지 IP 주소 필드를 기준으로 주소 지정이 이루어진다.

![](/assets/images/2024/2024-10-06-17-25-22.png)

<br>

### 2.3.1 식별자(identifier)

> 패킷에 할당된 고유한 번호가 명시가 된다.

쪼개져서 도착한 IPv4 패킷들이 **어떤 메시지에서 쪼개졌는지**를 알기 위해 사용된다.

![](/assets/images/2024/2024-10-06-17-26-58.png)

<br>

### 2.3.2 플래그(flag)

> 세 개의 비트로 구성되어 있는 필드를 말한다.

- 첫 번째 비트는 항상 0으로써 현재 사용되지 않으며, 실질적으로 사용되는 비트는 아래와 같다.
- DF 비트(Don't Fragment): IP 단편화 수행여부를 나타냄
  - 1이라면: IP 단편화 수행하지 말것
  - 0이라면: IP 단편화 가능하다
- MF 비트(More Fragment): 단편화된 패킷이 더 있는지를 나타냄
  - 1이라면: 쪼개진 패킷이 아직 더 있다.
  - 0이라면: 이 패킷이 마지막 패킷이다

![](/assets/images/2024/2024-10-06-17-28-45.png)

<br>

### 2.3.3 단편화 오프셋(fragment offset)

> 초기 데이터에서 몇 번쨰로 떨어진 패킷인지를 나타내는 필드를 말한다.

- 단편화되어 전송되는 패킷들은 수신지에 순서대로 도착하지 않을 수 있다.
- 수신지가 패킷들을 순서대로 재조합하려면 단편화된 패킷이 **초기 데이터에서 몇 번째에 해당하는 패킷**인지 알아야 한다.

![](/assets/images/2024/2024-10-06-17-34-32.png)

<br>

### 2.3.4 TTL(Time to Live)

> 패킷의 수명을 나타내는 필드를 말한다.

- 무의미한 패킷이 네트워크상에 지속적으로 남아있는 것을 방지하기 위해 존재한다.
- 패킷이 하나의 라우터를 거칠 때마다 TTL이 1씩 감소하고, TTL 값이 0으로 떨어진 패킷은 폐기된다.
- 홉(hop): 패킷이 호스트 또는 라우터에 한 번 전달되는 것을 말한다.
  - 즉, TTL 필드는 홉마다 1씩 감소되는 값이라고 볼 수 있다.

![](/assets/images/2024/2024-10-06-18-11-14.png)

<br>

### 2.3.5 프로토콜

> 상위 계층의 프로토콜이 무엇인지를 나타내는 필드이다.

- 즉, 무엇을 캡슐화했는지를 프로토콜 필드에 명시한다.
- ex. 전송 계층의 대표적인 프로토콜인 TCP는 6번, UDP는 17번

<br>

### 2.3.6 송/수신지 IP 주소

> 이름 그대로 송/수신지의 IPv4 주소를 의미한다.

<br><br>

# 3. IPv6

## 3.1 IPv6이란?

> IP 패킷의 헤더에는 송신지 IP 주소와 수신지 IP 주소를 명시할 수 있다! 하나의 IP주소는 32bit로 표현이 된다. 그럼 이론적으로 할당 가능한 IPv4 주소는 몇 개일까?

- 이론적으로 할당 가능한 IPv4 주소는, 총 2^32개로 약 43억 개이다.
- 하지만, 전 새계 인구가 하나씩 IP 주소를 가지고 있어도 부족한 숫자이다.
- 결국 약 43억 개라는 IPv4의 주소의 총량은 쉽게 고갈된다.

<br>

> 이런 IP 주소 부족 문제를 해결하기 위해 등장한 프로토콜이 IPv6이다.

- IPv6는 16바이트(128비트)로 주소를 표현할 수 있고, 콜론(:)으로 구분된 8개 그룹의 16진수로 표기된다.
- 이론적으로 할당 가능한 IPv6 주소는 2^128개이다. (사실상 무한에 가까운 수 할당 가능)
- IPv4 주소 표기: `192.168.1.1`
- IPv6 주소 표기: `2001:0230:abcd:ffff:0000:0000:ffff:1111`

<br>

## 3.2 IPv6 패킷의 핵심 필드

> IPv6 패킷의 핵심 필드는 1)다음 헤더, 2)홉 제한, 3)송신지 IP 주소, 4)수신지 IP 주소 가 존재한다.

![](/assets/images/2024/2024-10-06-18-24-47.png)

<br>

### 3.2.1 다음 헤더(next header)

> 상위 계층의 프로토콜 또는 확장 헤더를 가리키는 필드이다.

- 확장 헤더란?
  - IPv6는 기본 헤더와 더불어 확장 헤더라는 추가 헤더를 가질 수 있다.
  - 확장 헤더는 기본 헤더와 페이로드 데이터 사이에 위차한다.
  - 마치 꼬리를 물듯 또 다른 확장 헤더를 가질 수 있다.

![](/assets/images/2024/2024-10-06-18-26-50.png)
![](/assets/images/2024/2024-10-06-18-27-56.png)

<br>

- 대표적인 확장 헤더
  - 홉 간 옵션
  - 수신지 옵션
  - 라우팅
  - **단편**
  - ESP
  - ...

여기서 IPv6의 단편화와 깊이 연관되어있는 단편 헤더에 대해 자세히 살펴보도록 하자.

<br>

### 3.2.2 IPv6의 단편화

> IPv6는 단편화 확장 헤더를 통해 단편화가 이루어진다.

- 단편화 확장 헤더에도 다음 헤더 필드가 존재한다.
- 예약됨(reserved)과 예약(res) 필드는 0으로 설정되어 사용되지 않는다.
- 단편화 오프셋과 M 플래그, 식별자 필드를 갖는다.
  - 단편화 오프셋: 전체 메시지에서 현재 단편화된 패킷의 위치(IPv4의 단편화 오프셋 필드와 유사)
  - M 플래그: 1일 경우 더 많은 단편화 패킷이 있음을, 0일 경우 마지막 패킷을 의미(IPv4의 MF 플래그 필드와 유사)
  - 식별자: 동일한 메시지에서부터 단편화된 패킷임을 식별(IPv4의 식별자 필드와 유사)

![](/assets/images/2024/2024-10-06-18-30-38.png)

<br>

### 3.2.3 홉 제한(hop limit)

> 패킷의 수명을 나타내는 필드이다.

IPv4 패킷의 TTL 필드와 비슷하다.

<br>

### 3.2.4 송신지 IP 주소, 수신지 IP 주소

> IPv6 주소를 통한 송수신지를 지정하는 필드이다.

<br>
